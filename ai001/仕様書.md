
# /ai001 Performance 改善 仕様書

- **文書名**: 仕様書.md  
- **版数**: v1.0  
- **作成日**: 2025-10-16  
- **作成者**: 開発チーム  

---

## 0. 概要
本仕様書は、対象ページ **/ai001/** の *Lighthouse「Performance」モバイルスコア*を **70 点以上**に引き上げるための評価条件・許可/禁止範囲・改善ループ・回帰防止・ロールバック/ログ運用を定義する。外観や機能の変化を伴う HTML/CSS/JS 編集は禁止し、外観非依存の手段に限定して最適化を実施する。

---

## 1. 対象と目的
- **対象 URL（ビルド後）**: `http://localhost:3000/ai001/`
- **対象ページ**: `/ai001/` 単体（共通ヘッダー/フッター由来の変更は影響しうるが、評価対象は当該 URL）
- **目的**: *Lighthouse「Performance」モバイルスコア*を **70 点以上**へ引き上げる。

---

## 2. 用語定義
- **マルチエントリ**: 同一画面へ到達する複数の入口（例: `/ai001/` と `/ai001/index.html`、ルートの別名等）。入口が異なると初期読み込み資産やキャッシュが変わり、スコア再現性が落ちるため、本評価では**単一入口**に固定する。
- **リダイレクト**: 入口 URL から最終計測 URL に至るまでの 301/302/307 等の転送。本評価では**リダイレクトなし**を前提とし、発生時は課題として記録・解消する。
- **Lighthouse Performance（モバイル）**: Chrome Lighthouse によるモバイル相当条件でのパフォーマンススコア。参考指標として FCP/LCP/CLS/TBT/INP を監視する。
- **CLS（Cumulative Layout Shift）**: 読み込み中のレイアウトずれ量の総和。
- **INP（Interaction to Next Paint）**: ユーザー操作から次の描画までの時間の代表値。

---

## 3. スコア定義 / 非機能要件
- **主評価指標**: Lighthouse **Performance（Mobile）**
- **合格閾値**: 最新サイクルのスコア **≥ 70**
- **数値ガードレール（副作用監視）**:  
  - LCP ≤ 2.5s  
  - CLS ≤ 0.10  
  - INP ≤ 200ms  
  - TBT ≤ 200ms  
  ※上記が悪化した場合は施策をロールバックまたは見直し

---

## 4. 計測条件（一般的プリセットを採用・固定）
- **計測ツール**: DevtoolsMCP（内包/連携の Lighthouse を使用）
- **モード**: モバイル、シミュレーテッドスロットリング
- **デバイス擬似**: モバイル UA、ビューポート `360 × 640` 相当
- **CPU**: 4× throttle（DevTools の一般的プリセット）
- **ネットワーク**: **Slow 4G**（DevTools プリセット）
- **キャッシュ**: 初回訪問（cold）を基準。必要に応じて二回目訪問（warm）も補助記録
- **実行回数**: 各サイクル **3 回以上**の計測を行い、**中央値**を採用
- **ブラウザ/ツールのバージョン**: Chrome / DevTools / DevtoolsMCP のバージョンを毎サイクル**記録**
- **拡張機能**: 無効化
- **計測入口**: `http://localhost:3000/ai001/` に**直接アクセス**
- **マルチエントリ/リダイレクト**: 本評価は **/ai001/** 単一入口のみ。**リダイレクトなし**が前提。

---

## 5. スコープおよび変更範囲

### 5.1 厳守する制約
- **外観が変わるような CSS・JavaScript・HTML の編集は一切禁止。**
- 挙動（機能/順序/依存関係）に影響する変更は原則禁止。

### 5.2 許可（OK） — 外観/挙動非依存の最適化
- **サーバ/配信系**
  - HTTP 圧縮（**Brotli / Gzip**）の有効化・適正化
  - **HTTP/2 / HTTP/3**、Keep-Alive、TLS1.3、ALPN 等の伝送最適化
  - **CDN** 導入/設定（オリジン不変・コンテンツ不変の担保が必要）
  - キャッシュ制御最適化：`Cache-Control`, `ETag`, `Last-Modified`, `immutable`
    - ハッシュ付き静的資産は長期キャッシュ、HTML は短期
- **ビルド/アセット**
  - JS/CSS/HTML の**ミニファイ**（機能・順序不変の設定に限定）
  - 本番での**ソースマップ配信停止**
  - 画像の**ロスレス最適化**（EXIF 除去、無劣化圧縮、メタデータ整理）
  - SVG の**安全な最適化**（レンダリング結果不変の範囲）
- **ヘッダー/メタ（条件付き許可）**
  - `preconnect` / `dns-prefetch` の追加
  - `preload`（LCP 資産に限定）。**視覚回帰（§7）で差分 ≤ 0.1%**かつ**CLS/INP 悪化なし**を満たすこと

### 5.3 禁止（NG） — 外観/挙動に影響しうる変更
- レイアウト/描画経路に影響：**Critical CSS 抽出**、CSS の順序変更
- 画像の**非可逆圧縮**・サイズ/形式変更で視覚差が出るもの
- **フォント**の置換/サブセット化/表示戦略変更（FOUT/FOIT や幅差の恐れ）
- **Lazy-load 追加**、`defer/async` 付与等、**読み込み順**や**依存**を変える変更
- DOM 構造の変更、イベントハンドラの変更、バンドル分割ポリシー変更

---

## 6. 改善プロセス（改善ループ）
1. **計測**（§4 条件、3 回以上）：スコアと主要指標、環境情報を記録  
2. **課題抽出**：LCP リソース、ブロッキング資産、キャッシュ不備等のボトルネック特定  
3. **修正案立案**：§5 の許可範囲内で案出し、**想定効果/リスク**を明記  
4. **実装/設定変更**：PR は小さく一つずつ（ロールバック容易）  
5. **回帰防止チェック**（§7）：視覚回帰と CLS/INP の副作用監視  
6. **再計測**：同条件・中央値で効果検証  
7. **記録**：レポート保管・差分要約、次サイクルへ反映

---

## 7. 回帰防止（見た目・挙動の保証）
- **視覚回帰テスト（BA）**
  - モバイル幅で **Before/After** のスクリーンショット取得
  - 差分ツールまたはチーム内の画像レビューツール（例：**Codex** 等）で確認
  - **合格基準**：差分率 **≤ 0.1%**、明確な視覚差なし
- **副作用監視（数値ガードレール）**
  - 毎サイクル **CLS ≤ 0.10、INP ≤ 200ms** を確認。悪化時はロールバック
  - LCP/FCP/TBT も併記し、悪化は要因分析の上で是正
- **エラー/警告**
  - コンソールエラー/重大警告 **ゼロ** を維持。新規発生時はロールバック検討

---

## 8. ロールバックとログの扱い（作成指示を含む）

### 8.1 ディレクトリ構成と命名規則（**作成必須**）
```
/reports/devtools-mcp/
  {YYYYMMDD-HHMM}/
    conditions.json        # 計測条件（UA/viewport/CPU/Network/versions 等）
    run01_mobile.html      # DevtoolsMCP/Lighthouse レポート（HTML）
    run01_mobile.json      # 同 JSON
    run02_mobile.html
    run02_mobile.json
    summary.md             # サイクル要約（課題/施策/効果/次アクション）
    screenshots/
      before_ai001.png
      after_ai001.png
      diff_ai001.png
```
- **作成指示**: 各サイクル終了時に上記構成で**必ず保存**すること。画像は必要に応じて Git LFS 管理。

### 8.2 Git 運用（ロールバック容易性の担保）
- **ブランチ**: `perf/ai001/{短い説明}`（例：`perf/ai001/cache-headers`）  
- **PR 単位**: 施策は**小さく一つずつ**（レビュー容易/即時撤回可）  
- **タグ**: `perf-loop-{YYYYMMDD}-{n}`（例：`perf-loop-20251016-1`）  
- **コミットメッセージ規約**:  
  `perf(ai001): {施策名} | 期待効果: {指標} | リスク: {概要}`
- **ロールバック手順**:  
  1) 直近タグへ `git revert` または `git reset --hard {tag}`  
  2) 再デプロイ（環境標準に準拠）  
  3) 再計測して元状態への復帰を確認

---

## 9. 成果物
1. **計測レポート**（HTML/JSON、スクショ含む）：ファイル名、スコア、主要指標、課題一覧  
2. **修正内容と理由**：変更点、予想効果、リスク、許可/禁止該当の根拠  
3. **再計測結果と差分**：スコア/指標の改善幅、BA 差分、ガードレール遵守有無  
4. **追加施策案**：次サイクル候補と優先度（工数/効果/リスクで評価）

---

## 10. 合格基準（最終判定）
- 最新サイクルの **Lighthouse Performance（Mobile）スコア ≥ 70**
- **視覚回帰合格**（差分率 ≤ 0.1%）、**CLS ≤ 0.10 / INP ≤ 200ms** を満たす
- **3 回以上計測の中央値**採用、計測条件・ログ・差分記録が §8 の規約で揃っている

---

## 11. チェックリスト
- [ ] 計測入口は `http://localhost:3000/ai001/`、リダイレクトなし
- [ ] DevtoolsMCP/Lighthouse/Chrome のバージョンを `conditions.json` に記録
- [ ] 3 回以上計測し中央値採用
- [ ] サーバ圧縮 / HTTP2 or 3 / キャッシュ制御の見直し完了
- [ ] 禁止項目（非可逆画像圧縮・フォント変更・Lazy-load 追加 等）なし
- [ ] `preconnect`/`preload` の条件付き許可要件（BA ≤ 0.1%、CLS/INP 不悪化）を満たす
- [ ] レポート/スクショ/サマリは `/reports/devtools-mcp/{YYYYMMDD-HHMM}/` に保存
- [ ] 合格基準を満たす最終レポートが揃っている

---

## 付録 A: `conditions.json` サンプル
```json
{
  "targetUrl": "http://localhost:3000/ai001/",
  "mode": "mobile",
  "viewport": "360x640",
  "network": "Slow 4G",
  "cpuThrottling": 4,
  "cache": "cold",
  "runs": 3,
  "chromeVersion": "XX.YY.ZZ",
  "devtoolsVersion": "XX.YY",
  "devtoolsMcpVersion": "X.Y.Z",
  "extensionsDisabled": true
}
```

## 付録 B: `summary.md` テンプレート
```md
# /ai001 Performance 改善 サイクル サマリ

- 日時: {YYYY-MM-DD HH:MM}
- スコア（Mobile/中央値）: Before {score_before} → After {score_after}
- 主要指標: LCP {lcp_before}→{lcp_after} / CLS {cls_before}→{cls_after} / INP {inp_before}→{inp_after} / TBT {tbt_before}→{tbt_after}

## 課題一覧
- {課題1} / {根拠}
- {課題2} / {根拠}

## 実施施策（§5.2 許可範囲）
- {施策1}（期待効果: {指標}, リスク: {概要}）
- {施策2}（期待効果: {指標}, リスク: {概要}）

## 回帰防止
- 視覚回帰: 差分率 {diff_rate}%（合否: {OK/NG}）
- ガードレール: CLS {value} / INP {value}（合否: {OK/NG}）

## 再計測結果
- スコア差分: +{delta}
- 指標差分: LCP {Δ} / CLS {Δ} / INP {Δ} / TBT {Δ}

## 次サイクル案
- {案1}（効果/工数/リスク）
- {案2}（効果/工数/リスク）
```

---

以上。
